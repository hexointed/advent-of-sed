#!/bin/sed -rf
:a
N
$!ba
s/$/\n/
s/C/1C/g
:c
p
s/^([0-9]*\+[0-9]*Card [0-9]+:u*) +([0-9]+) ([^\n]*\|[^\n]* )\2([^[:digit:]])/\1u \2 \3\4/;tc
s/^([0-9]*\+[0-9]*Card [0-9]+:u*) +([0-9]+)/\1/;tc
s/^([0-9]*\+[0-9]*Card [0-9]+:u*) \|[^\n]*/\1/

s/C/bC/g
s/b//
:d
/u/{
  s/u//
  s/^(g*)(f+)([^f][^b]*)b/\1\2\3\2/
  bd
}
s/b//g
:b
/^(g*f*)f([^f])/{
  s//\1g\2/
  bb
}
s/^(g*)[^g][^\n]*\n/\1/
/Card/bc
s/[^g]//g
s/g/1+/g
s/.$//
